<?php/** * SNAPSMACK - System backup & recovery. * Provides SQL database extractions, technical media manifests, and source archival. * Orchestrates PharData-based compression for source-only tactical backups. * Git Version Official Alpha 0.5 */require_once 'core/auth.php';// --- 1. THE ENGINE: EXTRACTION LOGIC ---if (isset($_POST['action']) && $_POST['action'] === 'export') {    $type = $_POST['type'];    // SQL EXTRACTION: Processes Full Dumps, Schemas, or User Keys.    if (in_array($type, ['full', 'schema', 'keys'])) {        $filename = "snapsmack_" . $type . "_" . date('Y-m-d_H-i') . ".sql";        header('Content-Type: application/octet-stream');        header('Content-Disposition: attachment; filename="' . $filename . '"');                $output = "-- SnapSmack Backup Service\n-- Type: " . strtoupper($type) . "\n-- Date: " . date('Y-m-d H:i:s') . "\n\n";        $tables = ($type === 'keys') ? ['snap_users'] : ['snap_images', 'snap_categories', 'snap_image_cat_map', 'snap_comments', 'snap_users', 'snap_settings', 'snap_pages', 'snap_blogroll'];                foreach ($tables as $table) {            $res = $pdo->query("SHOW CREATE TABLE $table")->fetch(PDO::FETCH_ASSOC);            $output .= "DROP TABLE IF EXISTS `$table`;\n" . $res['Create Table'] . ";\n\n";                        if ($type !== 'schema') {                $rows = $pdo->query("SELECT * FROM $table")->fetchAll(PDO::FETCH_ASSOC);                foreach ($rows as $row) {                    $keys = array_map(function($k) { return "`$k`"; }, array_keys($row));                    $vals = array_map(function($v) use ($pdo) { return $v === null ? "NULL" : $pdo->quote($v); }, array_values($row));                    $output .= "INSERT INTO `$table` (" . implode(', ', $keys) . ") VALUES (" . implode(', ', $vals) . ");\n";                }                $output .= "\n";            }        }        echo $output;        exit;    }    // MEDIA MANIFEST: Generates a physical file map with integrity hashes.    if ($type === 'media') {        $filename = "snapsmack_media_manifest_" . date('Y-m-d_H-i') . ".txt";        header('Content-Type: text/plain');        header('Content-Disposition: attachment; filename="' . $filename . '"');        $rootPath = realpath(__DIR__);        $media_dirs = ['assets/img', 'media', 'uploads', 'img_uploads'];                 echo "SNAPSMACK MEDIA MANIFEST & RECOVERY MAP\n";        echo "Generated: " . date('Y-m-d H:i:s') . "\n";        echo "--------------------------------------------------\n\n";        echo "SECTION 1: PHYSICAL FILE TREE (WITH SHA-256 HASH)\n\n";        $total_size = 0;        $file_count = 0;        foreach ($media_dirs as $dir) {            $dirPath = $rootPath . '/' . $dir;            if (!is_dir($dirPath)) continue;            echo "[DIR] /$dir\n";            $files = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($dirPath, RecursiveDirectoryIterator::SKIP_DOTS));            foreach ($files as $file) {                if ($file->isDir()) continue;                                $size = $file->getSize();                $total_size += $size;                $file_count++;                                $filePath = $file->getRealPath();                $rel = str_replace($rootPath, '', $filePath);                $hash = hash_file('sha256', $filePath);                                echo sprintf("  |- %-45s | %10s bytes | %s\n", $rel, number_format($size), $hash);            }        }        echo "\nTOTALS: $file_count files | " . number_format($total_size / 1048576, 2) . " MB\n\n";        echo "--------------------------------------------------\n";        echo "SECTION 2: SQL RECOVERY (snap_images)\n\n";        $rows = $pdo->query("SELECT * FROM snap_images")->fetchAll(PDO::FETCH_ASSOC);        foreach ($rows as $row) {            $keys = array_map(function($k) { return "`$k`"; }, array_keys($row));            $vals = array_map(function($v) use ($pdo) { return $v === null ? "NULL" : $pdo->quote($v); }, array_values($row));            echo "INSERT INTO `snap_images` (" . implode(', ', $keys) . ") VALUES (" . implode(', ', $vals) . ");\n";        }                echo "\n--------------------------------------------------\n";        echo "SECTION 3: SQL RECOVERY (snap_image_cat_map)\n\n";        $rows_map = $pdo->query("SELECT * FROM snap_image_cat_map")->fetchAll(PDO::FETCH_ASSOC);        foreach ($rows_map as $row) {            $keys = array_map(function($k) { return "`$k`"; }, array_keys($row));            $vals = array_map(function($v) use ($pdo) { return $v === null ? "NULL" : $pdo->quote($v); }, array_values($row));            echo "INSERT INTO `snap_image_cat_map` (" . implode(', ', $keys) . ") VALUES (" . implode(', ', $vals) . ");\n";        }        exit;    }    // SOURCE ARCHIVE: Bundles logic and design files while excluding heavy media.    if ($type === 'source') {        $filename = "snapsmack_source_" . date('Y-m-d_H-i') . ".tar";        $tempPath = sys_get_temp_dir() . '/' . $filename;                try {            $a = new PharData($tempPath);            $rootPath = realpath(__DIR__);            $media_dirs = ['assets/img', 'media', 'uploads', 'img_uploads', 'skins'];            $files = new RecursiveIteratorIterator(                new RecursiveDirectoryIterator($rootPath, RecursiveDirectoryIterator::SKIP_DOTS),                RecursiveIteratorIterator::LEAVES_ONLY            );            foreach ($files as $name => $file) {                if ($file->isDir()) continue;                                $filePath = $file->getRealPath();                $relativePath = substr($filePath, strlen($rootPath) + 1);                $relativePath = str_replace('\\', '/', $relativePath);                $isMedia = false;                foreach ($media_dirs as $dir) {                    if (strpos($relativePath, $dir . '/') === 0) {                        $isMedia = true;                        break;                    }                }                if (!$isMedia && !str_contains($relativePath, '.tar')) {                    $a->addFile($filePath, $relativePath);                }            }            // Compress to GZ format and finalize stream.            $gzPath = $a->compress(Phar::GZ)->getPath();                        unset($a);             unlink($tempPath);            header('Content-Type: application/x-gzip');            header('Content-Disposition: attachment; filename="' . basename($gzPath) . '"');            header('Content-Length: ' . filesize($gzPath));            readfile($gzPath);            unlink($gzPath);            exit;                    } catch (Exception $e) {            die("RECOVERY_ENGINE_CRITICAL: " . $e->getMessage());        }    }}$page_title = "Backup & Recovery";include 'core/admin-header.php';include 'core/sidebar.php';?><div class="main">    <div class="header-row">        <h2>SYSTEM BACKUP & RECOVERY</h2>    </div>    <div class="dash-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">        <div class="box" style="display:flex; flex-direction:column;">            <h3>FULL DATABASE (THE BRAIN)</h3>            <p class="skin-desc-text">Extracts architecture and all content into a local SQL file. Standard tactical backup for site migrations.</p>            <form method="POST" style="margin-top:auto;">                <input type="hidden" name="action" value="export">                <input type="hidden" name="type" value="full">                <button type="submit" class="btn-smack btn-block">GET FULL SQL DUMP</button>            </form>        </div>        <div class="box" style="display:flex; flex-direction:column;">            <h3>EMERGENCY ACCESS (THE KEYS)</h3>            <p class="skin-desc-text">Extracts only the user credentials and permission hashes. Essential for regaining entry to the system.</p>            <form method="POST" style="margin-top:auto;">                <input type="hidden" name="action" value="export">                <input type="hidden" name="type" value="keys">                <button type="submit" class="btn-smack btn-block">GET RECOVERY SQL</button>            </form>        </div>        <div class="box" style="display:flex; flex-direction:column;">            <h3>ENGINE SCHEMA (THE DNA)</h3>            <p class="skin-desc-text">Extracts structure only. No user data, no images. Used for system updates or cloning the engine.</p>            <form method="POST" style="margin-top:auto;">                <input type="hidden" name="action" value="export">                <input type="hidden" name="type" value="schema">                <button type="submit" class="btn-smack btn-block">GET SCHEMA ONLY</button>            </form>        </div>    </div>        <div class="dash-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top:30px;">        <div class="box" style="display:flex; flex-direction:column;">            <h3>MEDIA LIBRARY MANIFEST</h3>            <p class="skin-desc-text">Generates a structural text map of all media assets, including physical SHA-256 hashes and requisite SQL recovery code.</p>            <form method="POST" style="margin-top:auto;">                <input type="hidden" name="action" value="export">                <input type="hidden" name="type" value="media">                <button type="submit" class="btn-smack btn-block">GENERATE MANIFEST</button>            </form>        </div>                <div class="box" style="display:flex; flex-direction:column;">            <h3>SITE SOURCE (.TAR.GZ)</h3>            <p class="skin-desc-text">Archives core PHP and CSS logic. Specifically excludes media directories to keep the footprint light.</p>            <form method="POST" style="margin-top:auto;">                <input type="hidden" name="action" value="export">                <input type="hidden" name="type" value="source">                <button type="submit" class="btn-smack btn-block">GET SOURCE CODE</button>            </form>        </div>    </div></div><?php include 'core/admin-footer.php'; ?>